name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Lint Dockerfile
        id: lint_dockerfile
        uses: hadolint/hadolint-action@v3.3.0
        continue-on-error: true
        with:
          dockerfile: .devcontainer/Dockerfile
          failure-threshold: warning

      - name: Lint Workflow
        id: lint_workflow
        uses: rhysd/actionlint@v1.7.10
        continue-on-error: true

      - name: Lint Markdown
        id: lint_markdown
        uses: DavidAnson/markdownlint-cli2-action@v16
        continue-on-error: true
        with:
          globs: "**/*.md"

      - name: Install Dev Container CLI
        run: npm install -g @devcontainers/cli

      - name: Validate Dev Container Config
        id: validate_devcontainer
        continue-on-error: true
        run: devcontainer read-configuration --workspace-folder .

      - name: Validate Renovate Config
        id: validate_renovate
        continue-on-error: true
        run: npx --yes --package renovate -- renovate-config-validator renovate.json

      - name: Check for linting failures
        if: always()
        run: |
          if [[ "${{ steps.lint_dockerfile.outcome }}" == "failure" || \
                "${{ steps.lint_workflow.outcome }}" == "failure" || \
                "${{ steps.lint_markdown.outcome }}" == "failure" || \
                "${{ steps.validate_devcontainer.outcome }}" == "failure" || \
                "${{ steps.validate_renovate.outcome }}" == "failure" ]]; then
            echo "One or more linting steps failed."
            exit 1
          fi

  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .devcontainer
          file: .devcontainer/Dockerfile
          push: false
          load: true
          tags: ai-devcontainer-base:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify tools as vscode user
        run: |
          docker run --rm --user vscode ai-devcontainer-base:test bash -c "
            set -e
            echo 'Testing as user: \$(whoami)'
            
            echo 'Checking node...'
            node --version
            
            echo 'Checking gh...'
            gh --version
            
            echo 'Checking claude...'
            claude --version
            
            echo 'Checking copilot...'
            copilot --version
            
            echo 'Checking gemini...'
            gemini --version
            
            echo 'Checking codex...'
            codex --version
            
            echo 'Checking opencode...'
            opencode --version
            
            echo 'Checking amp...'
            amp --version
            
            echo 'All checks passed!'
          "
